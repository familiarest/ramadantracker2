<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>Ramadan Tracker Pro</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200;300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --accent: #d4af37;
            --accent-glow: rgba(212, 175, 55, 0.4);
            --bg-color: #050505;
            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-white: #ffffff;
            --text-gray: #999;
            --green: #27ae60;
            --red: #e74c3c;
            --blue: #3498db;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        body {
            background-color: var(--bg-color) !important;
            background-image: radial-gradient(circle at 50% 0%, #1a1f2e 0%, #000000 80%);
            color: var(--text-white) !important;
            font-family: 'Manrope', sans-serif;
            margin: 0; padding: 0; 
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-user-select: none; user-select: none;
            width: 100vw;
        }
        
        body.no-scroll { overflow: hidden !important; height: 100vh; position: fixed; width: 100%; }
        input, textarea { -webkit-user-select: text !important; user-select: text !important; }

        /* –ó–í–ï–ó–î–´ –§–û–ù */
        #star-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; pointer-events: none; overflow: hidden;
        }
        .star-layer { position: absolute; top: 0; left: 0; right: 0; bottom: 0; will-change: transform; }
        .stars-1 { width: 1px; height: 1px; background: transparent; box-shadow: 10vw 10vh #fff, 20vw 50vh #fff, 30vw 20vh #fff, 80vw 80vh #fff, 90vw 10vh #fff, 50vw 50vh #fff; opacity: 0.8; }
        .stars-2 { width: 2px; height: 2px; background: transparent; box-shadow: 55vw 15vh #fff, 25vw 85vh #fff, 75vw 25vh #fff; opacity: 0.6; }
        .stars-3 { width: 3px; height: 3px; background: transparent; box-shadow: 15vw 35vh #fff, 45vw 65vh #fff; opacity: 0.4; }

        .container { max-width: 450px; margin: 0 auto; padding: 20px; padding-bottom: 160px; position: relative; z-index: 10; }

        /* UI ELEMENTS */
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .btn-mini {
            background: rgba(255, 255, 255, 0.05); color: #ccc; padding: 10px 16px; border-radius: 20px;
            font-size: 13px; font-weight: 600; border: 1px solid var(--glass-border);
            cursor: pointer; backdrop-filter: blur(10px); transition: 0.2s;
            position: relative; z-index: 20; display: flex; align-items: center; gap: 6px;
        }
        .btn-mini:active { transform: scale(0.95); background: rgba(255,255,255,0.1); }
        .btn-mini i { font-size: 16px; color: var(--accent); }
        
        .brand-link {
            display: block; text-align: center; font-size: 11px; color: var(--text-gray);
            text-decoration: none; font-weight: 500; margin-bottom: 30px; letter-spacing: 1px; text-transform: uppercase;
            position: relative; z-index: 20; opacity: 0.7; transition: opacity 0.2s;
        }
        .brand-link:hover { opacity: 1; }

        /* BELL NOTIFICATIONS */
        .notify-bell { 
            color: #555; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; 
            width: 32px; height: 32px; border-radius: 10px; background: rgba(0,0,0,0.3); border: 1px solid #333; 
        }
        .notify-bell i { font-size: 18px; transition: 0.2s; }
        .notify-bell.active { 
            color: var(--accent); filter: drop-shadow(0 0 10px var(--accent-glow)); 
            background: rgba(212, 175, 55, 0.1); border-color: rgba(212, 175, 55, 0.3); 
        }
        .notify-bell:active { transform: scale(0.9); }

        /* HEADER CIRCLE */
        .progress-header { display: flex; flex-direction: column; align-items: center; margin-bottom: 25px; position: relative; z-index: 11; }
        .circle-wrapper { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 10px; width: 100%; }
        .nav-arrow { font-size: 24px; color: #555; padding: 10px; cursor: pointer; transition: 0.2s; position: relative; z-index: 20; }
        .nav-arrow.disabled { opacity: 0.2; pointer-events: none; }
        
        .circle-container { position: relative; width: 180px; height: 180px; }
        svg { width: 100%; height: 100%; transform: rotate(135deg); overflow: visible; }
        circle { fill: none; stroke-width: 5; stroke-linecap: round; }
        .circle-bg { stroke: rgba(255, 255, 255, 0.05); }
        .circle-progress { 
            stroke: var(--accent); stroke-dasharray: 330 440; stroke-dashoffset: 330; 
            transition: stroke-dashoffset 0.8s cubic-bezier(0.4, 0, 0.2, 1), stroke 0.5s ease; 
            filter: drop-shadow(0 0 15px var(--accent-glow)); 
        }
        .day-info { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; margin-top: 10px; }
        .day-number { font-size: 64px; font-weight: 200; line-height: 1; letter-spacing: -2px; color: #fff; }
        .day-label { font-size: 11px; color: var(--text-gray); text-transform: uppercase; font-weight: 700; letter-spacing: 2px; margin-top: 5px; }
        .greeting-text { text-align: center; font-size: 14px; color: #aaa; line-height: 1.5; font-weight: 400; opacity: 0.8; margin-top: -10px;}
        #syncStatus { font-size: 11px; text-align: center; color: #555; height: 20px; line-height: 20px; margin-bottom: 15px; font-weight: 600; }
        #syncStatus.active { color: var(--green); }

        /* CARDS */
        .tracker-section { 
            background: var(--glass-bg); border-radius: 24px; padding: 24px; margin-bottom: 16px; 
            border: 1px solid var(--glass-border); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            position: relative; z-index: 11; 
        }
        .section-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 15px; }
        .section-title { font-size: 16px; font-weight: 700; color: #fff; display: flex; align-items: center; gap: 8px;}
        .section-title i.ph, .section-title i.ph-fill { font-size: 20px; color: var(--accent); }
        .section-percent { font-size: 32px; color: #fff; font-weight: 200; line-height: 1; letter-spacing: -1px; }
        .progress-bar-bg { width: 100%; height: 4px; background: rgba(255,255,255,0.05); border-radius: 6px; margin-bottom: 15px; overflow: hidden; }
        .progress-bar-fill { height: 100%; width: 0%; background: var(--accent); border-radius: 6px; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 0 10px var(--accent-glow); }
        .group-label { font-size: 10px; text-transform: uppercase; color: #666; font-weight: 700; margin-top: 20px; margin-bottom: 10px; letter-spacing: 1px; }

        /* FASTING TOGGLE */
        .fasting-switch { display: flex; background: rgba(0,0,0,0.3); border-radius: 16px; padding: 4px; margin-bottom: 15px; border: 1px solid #333; position: relative; z-index: 12; }
        .fasting-option { flex: 1; text-align: center; padding: 12px; font-size: 14px; font-weight: 600; color: #555; cursor: pointer; border-radius: 12px; transition: 0.3s; }
        .fasting-option.active-nothold { background: rgba(255,255,255,0.05); color: #aaa; }
        .fasting-option.active-hold { background: rgba(255,255,255,0.05); color: #fff; border: 1px solid var(--accent); box-shadow: 0 0 15px rgba(212,175,55,0.1); }
        
        .fasting-times-block { 
            background: rgba(255,255,255,0.03); 
            border-radius: 20px; 
            padding: 15px; 
            border: 1px solid rgba(255,255,255,0.08); 
            text-align: center; 
            margin-bottom: 5px; 
        }
        .time-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 8px; 
            position: relative;
            padding: 10px 0;
        }
        .time-row::after {
            content: ''; position: absolute; left: 50%; top: 5px; bottom: 5px; width: 1px;
            background: rgba(255,255,255,0.1); transform: translateX(-50%);
        }
        .time-item { flex: 1; display: flex; flex-direction: column; align-items: center; }
        .time-label { font-size: 11px; color: #777; text-transform: uppercase; margin-bottom: 6px; letter-spacing: 2px; font-weight: 700; }
        .time-val { font-size: 26px; font-weight: 400; color: #fff; letter-spacing: -1px; }
        .time-disclaimer { font-size: 11px; color: #555; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 5px;}
        .btn-set-city { background: transparent; border: 1px dashed #444; color: #888; padding: 12px; width: 100%; border-radius: 12px; cursor: pointer; font-family: 'Manrope'; font-size: 13px; }

        /* TASKS LIST */
        .task-item { display: flex; align-items: center; justify-content: space-between; padding: 14px 0; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; }
        .task-item:last-child { border-bottom: none; }
        .task-text { font-size: 15px; font-weight: 400; color: #ccc; flex-grow: 1; transition: color 0.2s;}
        .task-item.checked .task-text { color: #fff; }
        .checkbox { width: 24px; height: 24px; border-radius: 6px; border: 1px solid #444; display: flex; align-items: center; justify-content: center; transition: all 0.2s; background: transparent; flex-shrink: 0; }
        .task-item.checked .checkbox { background: var(--accent); border-color: var(--accent); box-shadow: 0 0 10px var(--accent-glow); }
        .checkbox::after { content: '‚úì'; font-size: 14px; display: none; font-weight: 800; color: #000; }
        .task-item.checked .checkbox::after { display: block; }
        
        .add-goal-area { display: flex; gap: 10px; margin-top: 15px; }
        .custom-input { flex: 1; border: 1px solid #333; background: rgba(0,0,0,0.3); padding: 12px; border-radius: 12px; font-size: 14px; color: #fff; outline: none; font-family: 'Manrope', sans-serif; }
        .btn-plus { width: 44px; background: rgba(255,255,255,0.05); border: 1px solid #333; border-radius: 12px; color: var(--accent); font-size: 24px; font-weight: 300; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .delete-custom { color: #555; padding: 10px; font-size: 18px; cursor: pointer; margin-right: -10px; transition: 0.2s; }
        .delete-custom:hover { color: var(--red); }

        /* COUNTERS UI (Water & Quran) */
        .counter-ui { display: flex; align-items: center; gap: 8px; background: rgba(0,0,0,0.3); padding: 4px; border-radius: 12px; border: 1px solid #333; }
        .counter-btn { width: 32px; height: 32px; background: rgba(255,255,255,0.05); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--accent); font-size: 18px; font-weight: 600; cursor: pointer; }
        .counter-btn:active { transform: scale(0.9); }
        .counter-val { min-width: 50px; text-align: center; font-size: 13px; font-weight: 700; color: #fff; }

        .stars { display: flex; justify-content: center; gap: 8px; margin-top: 10px; }
        .star { font-size: 32px; color: #333; cursor: pointer; transition: color 0.2s; }
        .star.active { color: var(--accent); text-shadow: 0 0 15px var(--accent-glow); }
        .journal-area { width: 100%; height: 120px; background: rgba(0,0,0,0.3); border: 1px solid #333; border-radius: 16px; padding: 15px; color: #fff; font-family: 'Manrope', sans-serif; font-size: 14px; resize: none; outline: none; margin-top: 5px; line-height: 1.5; }

        .bottom-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 30px; }
        .btn-finish { background: #fff; color: #000; width: 100%; padding: 18px; border: none; border-radius: 20px; font-size: 14px; font-weight: 800; cursor: pointer; text-transform: uppercase; font-family: 'Manrope', sans-serif; box-shadow: 0 0 20px rgba(255, 255, 255, 0.1); transition: 0.2s; }
        .btn-finish:active { transform: scale(0.98); }
        .btn-share { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; color: #fff; font-size: 14px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; text-transform: uppercase; backdrop-filter: blur(10px); transition: 0.2s; }
        .btn-share:active { transform: scale(0.98); background: rgba(255,255,255,0.1); }

        /* MODALS */
        .modal-overlay { position: fixed; bottom: 0; left: 0; width: 100%; height: 100%; background: #090e16; border-top-left-radius: 28px; border-top-right-radius: 28px; box-shadow: 0 -10px 50px rgba(0,0,0,0.8); transform: translateY(110%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); z-index: 200; display: flex; flex-direction: column; border-top: 1px solid #333; }
        .modal-overlay.show { transform: translateY(0); }
        .modal-header { padding: 20px; text-align: center; border-bottom: 1px solid #222; position: relative; flex-shrink: 0; }
        .modal-title { font-size: 18px; font-weight: 700; color: white; display: flex; align-items: center; justify-content: center; gap: 8px;}
        .close-modal { position: absolute; top: 20px; right: 20px; font-size: 24px; cursor: pointer; color: #666; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; z-index: 202; }
        .modal-content { flex: 1; overflow-y: auto; padding: 20px; color: white; position: relative; z-index: 201; padding-bottom: 80px; }

        /* SEARCH & CALENDAR */
        .search-input { width: 100%; padding: 16px; background: #222; border: 1px solid #444; color: white; border-radius: 14px; font-size: 15px; outline: none; font-family: 'Manrope'; }
        .search-results { margin-top: 10px; display: flex; flex-direction: column; gap: 8px; }
        .search-item { padding: 15px; background: rgba(255,255,255,0.05); border-radius: 12px; cursor: pointer; border: 1px solid transparent; transition: 0.2s; }
        .current-city-info { text-align: center; margin-bottom: 20px; padding: 15px; background: rgba(212,175,55,0.1); border-radius: 12px; border: 1px solid var(--accent); color: var(--accent); font-weight: 700; }
        .prayer-table { width: 100%; border-collapse: collapse; min-width: 500px; }
        .prayer-table th { text-align: left; font-size: 11px; color: #666; text-transform: uppercase; padding: 10px; border-bottom: 1px solid #333; vertical-align: bottom; }
        .th-sub { display: block; font-size: 9px; opacity: 0.7; margin-top: 2px; text-transform: none; }
        .prayer-table td { padding: 12px 10px; font-size: 13px; border-bottom: 1px solid #222; }
        .prayer-table tr.today-row { background: rgba(212, 175, 55, 0.15); border-left: 3px solid var(--accent); }

        /* STATS */
        .heatmap-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 6px; margin-bottom: 25px; }
        .heatmap-day { aspect-ratio: 1/1; background: #1a1a1a; border-radius: 6px; border: 1px solid #333; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 800; color: #555; transition: all 0.3s; }
        .heatmap-day.good { background: var(--green); color: #fff; }
        .heatmap-day.medium { background: var(--accent); color: #000; }
        .heatmap-day.bad { background: var(--red); color: #fff; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 25px; }
        .stat-card { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 16px; text-align: center; border: 1px solid #333; }
        .stat-num { font-size: 24px; font-weight: 800; color: var(--accent); margin-bottom: 4px; }
        .stat-desc { font-size: 11px; color: #aaa; font-weight: 600; text-transform: uppercase; }
        .full-stat-list { margin-top: 20px; background: rgba(255,255,255,0.03); border-radius: 16px; padding: 10px; }
        .full-stat-item { display: flex; justify-content: space-between; padding: 14px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 13px; }
        .fs-name { color: #ccc; font-weight: 500; }
        .fs-val { color: var(--accent); font-weight: 700; text-align: right; }
        
        .author-links { margin-top: 25px; display: flex; flex-direction: column; gap: 10px; }
        .author-btn { 
            display: flex; align-items: center; justify-content: center;
            width: 100%; padding: 14px; 
            background: rgba(255, 255, 255, 0.05); 
            border: 1px solid var(--glass-border); 
            border-radius: 16px; color: #ccc; 
            text-decoration: none; font-size: 13px; font-weight: 600; 
            backdrop-filter: blur(10px); transition: 0.2s;
        }
        .author-btn:active { transform: scale(0.98); background: rgba(255,255,255,0.1); }

        #hidden-share-wrapper {
            position: fixed; top: 0; left: 0; width: 0; height: 0; overflow: hidden; pointer-events: none; z-index: -9999;
        }
        #hidden-share-container {
            width: 600px; height: 750px; background: radial-gradient(circle at 50% 0%, #1a2332 0%, #000000 90%); display: flex; flex-direction: column; justify-content: space-between; align-items: center; padding: 50px 40px; text-align: center; font-family: 'Manrope', sans-serif; color: #fff; box-sizing: border-box;
        }
        #hidden-share-container .share-border {
            position: absolute; top: 15px; left: 15px; right: 15px; bottom: 15px; border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; pointer-events: none;
        }
        #generatedImageContainer { width: 100%; border-radius: 16px; overflow: hidden; margin-top: 20px; display: none; box-shadow: 0 10px 40px rgba(0,0,0,0.5); border: 1px solid #333; }
        #generatedImageContainer img { width: 100%; display: block; height: auto; }
        .btn-send-image {
            background: linear-gradient(135deg, #d4af37 0%, #b4932a 100%); color: #000; width: 100%; padding: 18px; border: none; border-radius: 20px; font-size: 14px; font-weight: 800; cursor: pointer; text-transform: uppercase; font-family: 'Manrope', sans-serif; box-shadow: 0 5px 20px rgba(212, 175, 55, 0.3); transition: transform 0.2s, opacity 0.2s;
        }
        .btn-send-image:active { transform: scale(0.96); }
        .btn-send-image:disabled { opacity: 0.7; cursor: wait; }
        .loading-text { color: #888; margin-top: 20px; font-size: 14px; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
    </style>
</head>
<body>

<div id="star-bg">
    <div class="star-layer stars-1"></div>
    <div class="star-layer stars-2"></div>
    <div class="star-layer stars-3"></div>
</div>

<div class="container">
    <div class="top-bar">
        <button class="btn-mini" id="btnStats"><i class="ph ph-chart-bar"></i> –û—Ç—á–µ—Ç</button>
        <button class="btn-mini" id="btnCalendar"><i class="ph ph-calendar-blank"></i> –ö–∞–ª–µ–Ω–¥–∞—Ä—å</button>
    </div>

    <a href="https://t.me/ametovstudio" class="brand-link" target="_blank">
        –¢—Ä–µ–∫–µ—Ä –ê–∑–∏–∑–∞ –ê–º–µ—Ç–æ–≤–∞ ‚Üó
    </a>

    <div class="progress-header">
        <div class="circle-wrapper">
            <div class="nav-arrow" id="prevDay"><i class="ph ph-caret-left"></i></div>
            <div class="circle-container">
                <svg viewBox="0 0 160 160" style="transform: rotate(135deg);">
                    <circle class="circle-bg" cx="80" cy="80" r="70" stroke-dasharray="330 440"></circle>
                    <circle class="circle-progress" id="monthCircle" cx="80" cy="80" r="70" stroke-dasharray="330 440"></circle>
                </svg>
                <div class="day-info">
                    <div class="day-number" id="uiDayNum">1</div>
                    <div class="day-label" id="uiDayLabel">–î–µ–Ω—å</div>
                </div>
            </div>
            <div class="nav-arrow disabled" id="nextDay"><i class="ph ph-caret-right"></i></div>
        </div>
        
        <div class="greeting-text">
            –ê—Å—Å–∞–ª—è–º—É –∞–ª–µ–π–∫—É–º, –¥–∞–≤–∞–π –ø—Ä–æ–≤–µ–¥–µ–º<br>—ç—Ç–æ—Ç –º–µ—Å—è—Ü –Ω–∞ –º–∞–∫—Å–∏–º–∞–ª–∫–∞—Ö?
        </div>
    </div>

    <div id="syncStatus">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

    <div class="tracker-section" style="border: 1px solid var(--glass-border); border-top: 2px solid var(--accent);">
        <div class="section-title" style="justify-content:center; margin-bottom:15px; position:relative;">
            <i class="ph ph-moon-stars"></i> –ü–æ—Å—Ç —Å–µ–≥–æ–¥–Ω—è
            <div class="notify-bell" id="bell-fasting" onclick="toggleNotify('fasting')" style="position:absolute; right:0; top:-5px;"><i class="ph ph-bell"></i></div>
        </div>
        <div class="fasting-switch">
            <div class="fasting-option" id="fastingNo" onclick="setFasting(false)">–ü—Ä–æ–ø—É—Å—Ç–∏–ª</div>
            <div class="fasting-option" id="fastingYes" onclick="setFasting(true)">–°–æ–±–ª—é–¥–∞—é</div>
        </div>
        
        <div class="fasting-times-block" id="fastingTimesBlock"></div>
    </div>

    <div class="tracker-section">
        <div class="section-header">
            <div class="section-title" style="display:flex; align-items:center; gap:8px;">
                <i class="ph ph-hands-praying"></i> –ù–∞–º–∞–∑
                <div class="notify-bell" id="bell-namaz" onclick="toggleNotify('namaz')" style="margin-left: 5px;"><i class="ph ph-bell"></i></div>
            </div>
            <div class="section-percent">0%</div>
        </div>
        <div class="progress-bar-bg"><div class="progress-bar-fill"></div></div>
        
        <div class="group-label">–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ (–í–ª–∏—è—é—Ç –Ω–∞ 80%)</div>
        <div class="task-item" onclick="toggleTask(this, 'fajr')"><span class="task-text">–§–∞–¥–∂—Ä</span><div class="checkbox"></div></div>
        <div class="task-item" onclick="toggleTask(this, 'dhuhr')"><span class="task-text">–ó—É—Ö—Ä</span><div class="checkbox"></div></div>
        <div class="task-item" onclick="toggleTask(this, 'asr')"><span class="task-text">–ê—Å—Ä</span><div class="checkbox"></div></div>
        <div class="task-item" onclick="toggleTask(this, 'maghrib')"><span class="task-text">–ú–∞–≥—Ä–∏–±</span><div class="checkbox"></div></div>
        <div class="task-item" onclick="toggleTask(this, 'isha')"><span class="task-text">–ò—à–∞</span><div class="checkbox"></div></div>
        
        <div class="group-label">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ</div>
        <div class="task-item" id="task-sunnah" onclick="toggleTask(this, 'sunnah')"><span class="task-text">–°—É–Ω–Ω–∞ –Ω–∞–º–∞–∑—ã</span><div class="checkbox"></div><div class="delete-custom" onclick="hideHardcodedTask('sunnah', event)">√ó</div></div>
        <div class="task-item" id="task-tarawih" onclick="toggleTask(this, 'tarawih')"><span class="task-text">–¢–∞—Ä–∞–≤–∏—Ö</span><div class="checkbox"></div><div class="delete-custom" onclick="hideHardcodedTask('tarawih', event)">√ó</div></div>
        <div class="task-item" id="task-witr" onclick="toggleTask(this, 'witr')"><span class="task-text">–í–∏—Ç—Ä</span><div class="checkbox"></div><div class="delete-custom" onclick="hideHardcodedTask('witr', event)">√ó</div></div>
        <div class="task-item" id="task-tahajjud" onclick="toggleTask(this, 'tahajjud')"><span class="task-text">–¢–∞—Ö–∞–¥–∂—É–¥</span><div class="checkbox"></div><div class="delete-custom" onclick="hideHardcodedTask('tahajjud', event)">√ó</div></div>
        
        <div id="extraPrayersContainer"></div>
        <div class="add-goal-area">
            <input type="text" class="custom-input" id="newPrayerInput" autocomplete="off" placeholder="–î–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–π –Ω–∞–º–∞–∑...">
            <div class="btn-plus" onclick="addNewCustom('extraPrayers', 'newPrayerInput')">+</div>
        </div>
    </div>

    <div class="tracker-section">
        <div class="section-header">
            <div class="section-title"><i class="ph ph-book-open-text"></i> –ó–Ω–∞–Ω–∏—è</div>
            <div class="section-percent">0%</div>
        </div>
        <div class="progress-bar-bg"><div class="progress-bar-fill"></div></div>
        <div class="task-item" style="cursor: default;">
            <span class="task-text">–ß–∏—Ç–∞–ª –ö—ä—É—Ä'–∞–Ω</span>
            <div class="counter-ui">
                <div class="counter-btn" onclick="updateQuran(-1)">-</div>
                <div class="counter-val" id="quranCountText">0 —Å—Ç—Ä</div>
                <div class="counter-btn" onclick="updateQuran(1)">+</div>
            </div>
        </div>
        <div class="task-item" id="task-lecture" onclick="toggleTask(this, 'lecture')"><span class="task-text">–ü—Ä–æ—Å–ª—É—à–∞–ª –ª–µ–∫—Ü–∏—é</span><div class="checkbox"></div><div class="delete-custom" onclick="hideHardcodedTask('lecture', event)">√ó</div></div>
        <div class="task-item" id="task-arabic" onclick="toggleTask(this, 'arabic')"><span class="task-text">–ò–∑—É—á–∞–ª –∞—Ä–∞–±—Å–∫–∏–π</span><div class="checkbox"></div><div class="delete-custom" onclick="hideHardcodedTask('arabic', event)">√ó</div></div>

        <div id="extraKnowledgeContainer"></div>
        <div class="add-goal-area">
            <input type="text" class="custom-input" id="newKnowledgeInput" autocomplete="off" placeholder="–î–æ–±–∞–≤–∏—Ç—å —Ü–µ–ª—å...">
            <div class="btn-plus" onclick="addNewCustom('extraKnowledge', 'newKnowledgeInput')">+</div>
        </div>
    </div>

    <div class="tracker-section">
        <div class="section-header">
            <div class="section-title"><i class="ph ph-bowl-food"></i> –ü–∏—Ç–∞–Ω–∏–µ</div>
            <div class="section-percent">0%</div>
        </div>
        <div class="progress-bar-bg"><div class="progress-bar-fill"></div></div>
        
        <div class="task-item" style="cursor: default;">
            <span class="task-text">–í–æ–¥–∞</span>
            <div class="counter-ui">
                <div class="counter-btn" onclick="updateWater(-1)">-</div>
                <div class="counter-val" id="waterCountText">0 –º–ª</div>
                <div class="counter-btn" onclick="updateWater(1)">+</div>
            </div>
        </div>
        
        <div class="task-item" id="task-suhoor" onclick="toggleTask(this, 'suhoor')"><span class="task-text">–ü—Ä–æ—Å–Ω—É–ª—Å—è –Ω–∞ —Å—É—Ö—É—Ä</span><div class="checkbox"></div><div class="delete-custom" onclick="hideHardcodedTask('suhoor', event)">√ó</div></div>
        <div class="task-item" id="task-no_overeat" onclick="toggleTask(this, 'no_overeat')"><span class="task-text">–ù–µ –ø–µ—Ä–µ–µ–ª –Ω–∞ –∏—Ñ—Ç–∞—Ä</span><div class="checkbox"></div><div class="delete-custom" onclick="hideHardcodedTask('no_overeat', event)">√ó</div></div>
    </div>

    <div class="tracker-section">
        <div class="section-header">
            <div class="section-title"><i class="ph ph-sparkle"></i> –õ–∏—á–Ω–æ—Å—Ç—å</div>
            <div class="section-percent">0%</div>
        </div>
        <div class="progress-bar-bg"><div class="progress-bar-fill"></div></div>
        
        <div class="task-item" onclick="toggleTask(this, 'no_bad_words')"><span class="task-text">–ù–µ –∑–ª–æ—Å–ª–æ–≤–∏–ª</span><div class="checkbox"></div></div>
        <div class="task-item" onclick="toggleTask(this, 'no_gossip')"><span class="task-text">–ù–µ —Å–ø–ª–µ—Ç–Ω–∏—á–∞–ª</span><div class="checkbox"></div></div>
        <div class="task-item" id="task-sadaqah" onclick="toggleTask(this, 'sadaqah')"><span class="task-text">–°–¥–µ–ª–∞–ª —Å–∞–¥–∞–∫–∞</span><div class="checkbox"></div><div class="delete-custom" onclick="hideHardcodedTask('sadaqah', event)">√ó</div></div>
        
        <div class="group-label">–ú–æ–∏ —Ü–µ–ª–∏</div>
        <div id="extraGoalsContainer"></div>

        <div class="add-goal-area">
            <input type="text" class="custom-input" id="newGoalInput" autocomplete="off" placeholder="–ù–∞–ø–∏—à–∏ —Å–≤–æ—é —Ü–µ–ª—å...">
            <div class="btn-plus" onclick="addNewCustom('extraGoals', 'newGoalInput')">+</div>
        </div>
    </div>

    <div class="tracker-section">
        <div class="section-title" style="margin-bottom:10px;"><i class="ph ph-pencil-simple"></i> –ú—ã—Å–ª–∏ –∑–∞ –¥–µ–Ω—å</div>
        <textarea id="dailyThoughts" class="journal-area" autocomplete="off" placeholder="–ß—Ç–æ —Å–µ–≥–æ–¥–Ω—è –æ—Å–æ–∑–Ω–∞–ª?..." oninput="saveThoughts()"></textarea>
    </div>

    <div class="tracker-section">
        <div class="section-title" style="justify-content:center;"><i class="ph ph-star"></i> –û—Ü–µ–Ω–∫–∞ –¥–Ω—è</div>
        <div class="stars">
            <div class="star" data-val="1">‚òÖ</div>
            <div class="star" data-val="2">‚òÖ</div>
            <div class="star" data-val="3">‚òÖ</div>
            <div class="star" data-val="4">‚òÖ</div>
            <div class="star" data-val="5">‚òÖ</div>
        </div>
    </div>

    <div class="bottom-actions">
        <button class="btn-finish" id="btnFinish">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–µ–Ω—å</button>
        <button class="btn-share" id="btnShare"><i class="ph ph-export"></i> –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
    </div>
</div>

<div class="modal-overlay" id="modalCalendar">
    <div class="modal-header">
        <div class="modal-title" id="calTitle">üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å</div>
        <div class="close-modal" onclick="closeModal('modalCalendar')">√ó</div>
    </div>
    <div class="modal-content" id="calContent"></div>
</div>

<div class="modal-overlay" id="modalStats">
    <div class="modal-header">
        <div class="modal-title">üìä –¢–≤–æ–π –û—Ç—á–µ—Ç</div>
        <div class="close-modal" onclick="closeModal('modalStats')">√ó</div>
    </div>
    <div class="modal-content">

        <div class="tracker-section" style="padding: 15px; margin-bottom: 25px;">
            <div class="section-title" style="margin-bottom: 10px; font-size: 14px;">–ó–∞–∫—è—Ç –∞–ª—å-—Ñ–∏—Ç—Ä</div>
            <div class="fasting-switch" style="margin-bottom: 0;">
                <div class="fasting-option" id="zakatNo" onclick="toggleZakat(false)">–ù–µ –≤—ã–ø–ª–∞—Ç–∏–ª</div>
                <div class="fasting-option" id="zakatYes" onclick="toggleZakat(true)">–í—ã–ø–ª–∞—Ç–∏–ª</div>
            </div>
        </div>

        <div class="group-label" style="margin-bottom:10px;">–ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –¥–Ω—è–º</div>
        <div class="heatmap-grid" id="heatmapGrid"></div>

        <div class="stat-grid">
            <div class="stat-card"><div class="stat-num" id="statDays">0</div><div class="stat-desc">–î–Ω–µ–π –ø—Ä–æ–π–¥–µ–Ω–æ</div></div>
            <div class="stat-card"><div class="stat-num" id="statRating">0.0</div><div class="stat-desc">–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞</div></div>
        </div>

        <div class="ai-feedback" style="margin-bottom:10px;">
            <div class="group-label">–ú–Ω–µ–Ω–∏–µ —Ç—Ä–µ–∫–µ—Ä–∞</div>
            <div class="ai-text" id="aiText" style="color:#ddd; font-size:14px; line-height:1.4;">...</div>
        </div>

        <div class="group-label">–ü–æ–¥—Ä–æ–±–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
        <div class="full-stat-list" id="statFullList"></div>

        <div class="author-links">
            <a href="https://t.me/ametovstudio" target="_blank" class="author-btn">Telegram: @ametovstudio</a>
            <a href="https://instagram.com/a.ametov" target="_blank" class="author-btn">Instagram: @a.ametov</a>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modalShare">
    <div class="modal-header">
        <div class="modal-title">üì∏ –ü–æ–¥–µ–ª–∏—Å—å —É—Å–ø–µ—Ö–æ–º</div>
        <div class="close-modal" onclick="closeModal('modalShare')">√ó</div>
    </div>
    <div class="modal-content" style="display:flex; flex-direction:column; align-items:center;">
        
        <div id="loadingState" class="loading-text" style="display:none;">–°–æ–∑–¥–∞–µ–º –∫—Ä–∞—Å–æ—Ç—É...</div>
        <div id="generatedImageContainer"></div>
        <div id="shareHint" style="margin-bottom:20px; color:#666; font-size:12px; margin-top: 15px; display:none;">–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, –µ—Å–ª–∏ –º–µ–Ω—é –Ω–µ –æ—Ç–∫—Ä—ã–ª–æ—Å—å</div>

        <button class="btn-send-image" id="btnGenImage" onclick="manualShare()" style="display:none;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
</div>

<div id="hidden-share-wrapper">
    <div id="hidden-share-container">
        <div class="share-border"></div>
        
        <div style="width: 100%; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 25px;">
            <div style="font-size: 22px; font-weight: 300; color: #aaa; letter-spacing: 5px; text-transform: uppercase;">–†–∞–º–∞–¥–∞–Ω 2026</div>
            <div id="renderDate" style="font-size: 18px; color: #d4af37; font-weight: 700; margin-top: 10px;">...</div>
        </div>

        <div style="flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%;">
            <div style="position: relative; width: 300px; height: 300px; display: flex; align-items: center; justify-content: center; top: 20px;">
                
                <canvas id="renderCanvas" width="300" height="300" style="position: absolute; top:0; left:0;"></canvas>

                <div style="position: absolute; display: flex; flex-direction: column; align-items: center; z-index: 10;">
                    <div id="renderDayNum" style="font-size: 110px; font-weight: 200; color: #fff; line-height: 0.9;">1</div>
                    <div style="font-size: 14px; font-weight: 800; color: #666; letter-spacing: 4px; text-transform: uppercase; margin-top: 10px;">–î–µ–Ω—å</div>
                </div>
            </div>

            <div id="renderAiText" style="font-size: 20px; color: #eee; font-weight: 500; margin-top: 35px; max-width: 85%; line-height: 1.5; font-style: italic;">...</div>
            <div id="renderStars" style="display: flex; gap: 15px; font-size: 44px; margin-top: 25px;"></div>
        </div>

        <div style="width: 100%; padding-top: 25px; border-top: 1px solid rgba(255,255,255,0.1);">
            <div style="font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px;">–ú–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ –±–æ—Ç–µ</div>
            <div style="font-size: 16px; color: #fff; font-weight: 700;">@ramadantracking_bot</div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modalFinal">
    <div class="modal-header">
        <div class="modal-title">üéâ –ò—Ç–æ–≥–∏ –†–∞–º–∞–¥–∞–Ω–∞</div>
        <div class="close-modal" onclick="closeModal('modalFinal')">√ó</div>
    </div>
    <div class="modal-content">
        <div style="text-align:center; margin-bottom:20px;">
            <div style="font-size:16px; color:#aaa;">–ê–ª—å—Ö–∞–º–¥—É–ª–∏–ª–ª—è—Ö, –º–µ—Å—è—Ü –ø—Ä–æ—à–µ–ª.</div>
            <div style="font-size:22px; font-weight:800; color:var(--accent);">–¢–≤–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</div>
        </div>

        <div class="stat-grid">
            <div class="stat-card"><div class="stat-num" id="f_avg">0%</div><div class="stat-desc">–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div></div>
            <div class="stat-card"><div class="stat-num" id="f_fast">0</div><div class="stat-desc">–ü—Ä–æ–ø—É—Å—Ç–∏–ª –ø–æ—Å—Ç</div></div>
        </div>

        <div class="group-label">–ü–æ–¥—Ä–æ–±–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
        <div class="full-stat-list" id="f_fullList"></div>

        <div class="group-label">–¢–æ–ø –º—ã—Å–ª–µ–π –∑–∞ –º–µ—Å—è—Ü</div>
        <div class="thoughts-list" id="f_thoughts">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π.</div>

        <div class="ai-feedback">
            <div class="ai-title">ü§ñ –ò—Ç–æ–≥ –æ—Ç —Ä–æ–±–æ—Ç–∞</div>
            <div class="ai-text" id="f_robot">...</div>
        </div>

        <button class="btn-share" onclick="openShareFinal()">üì∏ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞ –ø–∞–º—è—Ç—å</button>
    </div>
</div>

<script>
    let tg = window.Telegram ? window.Telegram.WebApp : null;
    if (tg) { tg.expand(); tg.MainButton.hide(); tg.setHeaderColor('#050505'); tg.setBackgroundColor('#000000'); }

    window.addEventListener('scroll', () => {
        const scrolled = window.scrollY;
        requestAnimationFrame(() => {
            document.querySelector('.stars-1').style.transform = `translateY(${scrolled * 0.3}px)`;
            document.querySelector('.stars-2').style.transform = `translateY(${scrolled * 0.2}px)`;
            document.querySelector('.stars-3').style.transform = `translateY(${scrolled * 0.1}px)`;
        });
    });

    let ramadanStart = new Date(2026, 1, 18); // –ë–∞–∑–æ–≤–æ 18 —Ñ–µ–≤—Ä–∞–ª—è
    const STORAGE_KEY = 'ramadan_tracker_pro_v2';
    const CALENDAR_STORAGE_KEY = 'ramadan_api_calendar_v2';
    const CITY_NAME_KEY = 'ramadan_city_name_v2';
    const COUNTRY_FLAG_KEY = 'ramadan_country_cis_v2';

    // –§—É–Ω–∫—Ü–∏—è –æ–±–µ—Ä—Ç–∫–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –æ–±–ª–∞–∫–æ –∏ –ª–æ–∫–∞–ª—å–Ω–æ
    function sysSave(key, val) {
        localStorage.setItem(key, val);
        if(tg && tg.CloudStorage) tg.CloudStorage.setItem(key, String(val));
    }

    function getCurrentDay() {
        const now = new Date();
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º UTC –¥–ª—è —Ä–∞—Å—á–µ—Ç–æ–≤, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Å–±–æ–µ–≤ –∏–∑-–∑–∞ —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–æ–≤ (DST)
        const utcStart = Date.UTC(ramadanStart.getFullYear(), ramadanStart.getMonth(), ramadanStart.getDate());
        const utcNow = Date.UTC(now.getFullYear(), now.getMonth(), now.getDate());
        const diff = utcNow - utcStart;
        let day = Math.floor(diff / (1000 * 60 * 60 * 24)) + 1;
        if (day < 1) return 1;
        return day > 30 ? 30 : day;
    }

    let realDayNum = getCurrentDay();
    let activeDayNum = realDayNum;
    let fullHistory = { settings: { hiddenTasks: [], notifications: { fasting: false, namaz: false } } };

    function initApp() {
        if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
            const user = tg.initDataUnsafe.user;
        }
        
        // Zakat Init (—Å–Ω–∞—á–∞–ª–∞ –ª–æ–∫–∞–ª—å–Ω–æ –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏)
        const zakatPaid = localStorage.getItem('zakat_paid') === 'true';
        updateZakatUI(zakatPaid);

        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞—Ç—ã —Å—Ç–∞—Ä—Ç–∞ –ø–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–º—É —Ä–µ–≥–∏–æ–Ω—É
        const isCis = localStorage.getItem(COUNTRY_FLAG_KEY) === 'true';
        ramadanStart = isCis ? new Date(2026, 1, 19) : new Date(2026, 1, 18);
        realDayNum = getCurrentDay();
        activeDayNum = realDayNum;

        try {
            const loc = localStorage.getItem(STORAGE_KEY);
            if(loc) {
                 fullHistory = JSON.parse(loc);
                 if(!fullHistory.settings) fullHistory.settings = { hiddenTasks: [], notifications: { fasting: false, namaz: false } };
                 if(!fullHistory.settings.notifications) fullHistory.settings.notifications = { fasting: false, namaz: false };
                 document.getElementById('syncStatus').innerText = "‚ú® –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ";
            }
            renderDay(activeDayNum);
            
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –í–°–ï –∫–ª—é—á–∏ –∏–∑ –æ–±–ª–∞–∫–∞ –∏ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ
            if (tg && tg.CloudStorage) {
                const keysToSync = [STORAGE_KEY, CALENDAR_STORAGE_KEY, CITY_NAME_KEY, COUNTRY_FLAG_KEY, 'zakat_paid'];
                tg.CloudStorage.getItems(keysToSync, (err, values) => {
                    if (!err && values) { 
                        let needsRender = false;
                        
                        if(values[COUNTRY_FLAG_KEY] !== undefined) {
                            const cloudIsCis = values[COUNTRY_FLAG_KEY] === 'true';
                            ramadanStart = cloudIsCis ? new Date(2026, 1, 19) : new Date(2026, 1, 18);
                            localStorage.setItem(COUNTRY_FLAG_KEY, values[COUNTRY_FLAG_KEY]);
                            realDayNum = getCurrentDay();
                            activeDayNum = realDayNum;
                            needsRender = true;
                        }
                        if(values[CITY_NAME_KEY] !== undefined) {
                            localStorage.setItem(CITY_NAME_KEY, values[CITY_NAME_KEY]);
                            needsRender = true;
                        }
                        if(values[CALENDAR_STORAGE_KEY] !== undefined) {
                            localStorage.setItem(CALENDAR_STORAGE_KEY, values[CALENDAR_STORAGE_KEY]);
                            needsRender = true;
                        }
                        if(values['zakat_paid'] !== undefined) {
                            localStorage.setItem('zakat_paid', values['zakat_paid']);
                            updateZakatUI(values['zakat_paid'] === 'true');
                        }
                        if(values[STORAGE_KEY] !== undefined) {
                            try { 
                                const cloudData = JSON.parse(values[STORAGE_KEY]);
                                fullHistory = cloudData;
                                if(!fullHistory.settings) fullHistory.settings = { hiddenTasks: [], notifications: { fasting: false, namaz: false } };
                                if(!fullHistory.settings.notifications) fullHistory.settings.notifications = { fasting: false, namaz: false };
                                localStorage.setItem(STORAGE_KEY, values[STORAGE_KEY]);
                                needsRender = true;
                            } catch(e) {}
                        }
                        
                        if (needsRender) {
                            document.getElementById('syncStatus').innerText = "‚òÅÔ∏è –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ";
                            renderDay(activeDayNum);
                        }
                    }
                });
            }
        } catch(e) { renderDay(activeDayNum); }
    }

    // –ù–û–í–ê–Ø –°–ò–°–¢–ï–ú–ê –ü–û–î–°–ß–ï–¢–ê –ë–ê–õ–õ–û–í
    function calculateDayScore(dayData) {
        if (!dayData) return 0;
        
        // 1. –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ 80%
        let mandatoryScore = 0;
        if (dayData.fasting) mandatoryScore += 16;
        if (dayData.tasks?.fajr) mandatoryScore += 8;
        if (dayData.tasks?.dhuhr) mandatoryScore += 8;
        if (dayData.tasks?.asr) mandatoryScore += 8;
        if (dayData.tasks?.maghrib) mandatoryScore += 8;
        if (dayData.tasks?.isha) mandatoryScore += 8;
        if (dayData.quranPageCount > 0) mandatoryScore += 8;
        if (dayData.tasks?.no_bad_words) mandatoryScore += 8;
        if (dayData.tasks?.no_gossip) mandatoryScore += 8;

        // 2. –ñ–µ–ª–∞—Ç–µ–ª—å–Ω—ã–µ 20%
        let optionalScore = 0;
        const optionalTasks = ['sunnah', 'tarawih', 'witr', 'tahajjud', 'lecture', 'arabic', 'sadaqah', 'suhoor', 'no_overeat'];
        optionalTasks.forEach(t => {
            if (dayData.tasks && dayData.tasks[t] && !fullHistory.settings.hiddenTasks.includes(t)) optionalScore += 2;
        });
        
        // –í–æ–¥–∞ (1 –∫–ª–∏–∫ = 250–º–ª = 0.5 –±–∞–ª–ª–∞, –º–∞–∫—Å–∏–º—É–º 5 –±–∞–ª–ª–æ–≤ –∑–∞ –≤–æ–¥—É)
        if (dayData.water && dayData.water > 0) optionalScore += Math.min(dayData.water * 0.5, 5);

        // –ö–∞—Å—Ç–æ–º–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        ['extraPrayers', 'extraKnowledge', 'extraGoals'].forEach(cat => {
            if(dayData[cat]) {
                dayData[cat].forEach(g => { if(g.done) optionalScore += 2; });
            }
        });

        if (optionalScore > 20) optionalScore = 20;

        const total = Math.round(mandatoryScore + optionalScore);
        return total > 100 ? 100 : total;
    }

    function getStoredCalendar() {
        const str = localStorage.getItem(CALENDAR_STORAGE_KEY);
        return str ? JSON.parse(str) : null;
    }

    function renderDay(dayNum) {
        document.getElementById('uiDayNum').innerText = dayNum;
        document.getElementById('prevDay').classList.toggle('disabled', dayNum <= 1);
        document.getElementById('nextDay').classList.toggle('disabled', dayNum >= realDayNum);
        
        const data = fullHistory[dayNum] || { tasks: {}, rating: 0, thoughts: "", fasting: false, extraGoals: [], extraKnowledge: [], extraPrayers: [], water: 0, quranPageCount: 0 };
        if(!data.tasks) data.tasks = {};

        const isFasting = (data.fasting === true); 
        const btnYes = document.getElementById('fastingYes');
        const btnNo = document.getElementById('fastingNo');
        btnYes.className = 'fasting-option';
        btnNo.className = 'fasting-option';
        if(isFasting) btnYes.classList.add('active-hold'); else btnNo.classList.add('active-nothold');

        const timeBlock = document.getElementById('fastingTimesBlock');
        const calendar = getStoredCalendar();
        
        if(calendar && calendar[dayNum-1]) {
            const times = calendar[dayNum-1];
            const cityName = localStorage.getItem(CITY_NAME_KEY) || "–ì–æ—Ä–æ–¥";
            
            timeBlock.innerHTML = `
                <div style="font-size:10px; color:#888; margin-bottom:8px; text-transform:uppercase; letter-spacing:1px;">* –í—Ä–µ–º—è —É–∫–∞–∑–∞–Ω–æ –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ</div>
                <div class="time-row">
                    <div class="time-item">
                        <span class="time-label">–°—É—Ö—É—Ä</span>
                        <span class="time-val">${times.fajr}</span>
                    </div>
                    <div class="time-item">
                        <span class="time-label">–ò—Ñ—Ç–∞—Ä</span>
                        <span class="time-val" style="color:var(--accent)">${times.maghrib}</span>
                    </div>
                </div>
                <div class="time-disclaimer"><i class="ph ph-map-pin"></i> ${cityName}</div>
                <div style="text-align:center; margin-top:10px; font-size:10px; color:#444; cursor:pointer;" onclick="openCityModal()">–ò–∑–º–µ–Ω–∏—Ç—å –ª–æ–∫–∞—Ü–∏—é</div>
            `;
        } else {
            timeBlock.innerHTML = `<button class="btn-set-city" onclick="openCityModal()">üìç –í—ã–±—Ä–∞—Ç—å –≥–æ—Ä–æ–¥</button>`;
        }

        ['sunnah', 'tarawih', 'witr', 'tahajjud', 'lecture', 'arabic', 'sadaqah', 'suhoor', 'no_overeat'].forEach(id => {
            const el = document.getElementById('task-' + id);
            if(el) {
                if(fullHistory.settings?.hiddenTasks?.includes(id)) el.style.display = 'none';
                else el.style.display = 'flex';
            }
        });

        document.querySelectorAll('.task-item').forEach(el => {
            if(!el.id || !el.id.startsWith('task-')) el.classList.remove('checked');
            else el.classList.remove('checked');
        });

        for(const [id, done] of Object.entries(data.tasks)) {
            if(done) {
                const els = document.querySelectorAll('.task-item');
                els.forEach(el => {
                    if(el.getAttribute('onclick') && el.getAttribute('onclick').includes(`'${id}'`)) el.classList.add('checked');
                });
            }
        }
        
        const waterVal = data.water || 0;
        document.getElementById('waterCountText').innerText = (waterVal * 250) + ' –º–ª';
        
        const quranVal = data.quranPageCount || 0;
        document.getElementById('quranCountText').innerText = quranVal + ' —Å—Ç—Ä';

        document.getElementById('dailyThoughts').value = data.thoughts || "";

        renderCustomList(data, 'extraGoals', 'extraGoalsContainer');
        renderCustomList(data, 'extraKnowledge', 'extraKnowledgeContainer');
        renderCustomList(data, 'extraPrayers', 'extraPrayersContainer');
        
        const r = data.rating || 0;
        document.querySelectorAll('.star').forEach(s => s.classList.toggle('active', parseInt(s.dataset.val) <= r));
        
        document.querySelectorAll('.tracker-section').forEach(updateSectionProgress);
        updateDailyCircle();
        updateBellsUI();
    }

    function renderCustomList(data, category, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        if(data[category] && data[category].length > 0) {
            data[category].forEach((goal, idx) => {
                const checked = goal.done ? 'checked' : '';
                const html = `
                <div class="task-item ${checked}" style="margin-bottom:1px;">
                      <span class="task-text" onclick="toggleCustom('${category}', ${idx})">${goal.text}</span>
                      <div class="checkbox" onclick="toggleCustom('${category}', ${idx})"></div>
                      <div class="delete-custom" onclick="removeCustom('${category}', ${idx})">√ó</div>
                </div>`;
                container.insertAdjacentHTML('beforeend', html);
            });
        }
    }

    window.updateWater = function(delta) {
        ensureDayObj(activeDayNum);
        let current = fullHistory[activeDayNum].water || 0;
        current += delta;
        if(current < 0) current = 0;
        fullHistory[activeDayNum].water = current; 
        if(delta > 0) hapticBurst(1); else haptic();
        renderDay(activeDayNum);
        saveData();
    }

    window.updateQuran = function(delta) {
        ensureDayObj(activeDayNum);
        let current = fullHistory[activeDayNum].quranPageCount || 0;
        current += delta;
        if(current < 0) current = 0;
        fullHistory[activeDayNum].quranPageCount = current;
        if(delta > 0) hapticBurst(1); else haptic();
        renderDay(activeDayNum);
        saveData();
    }

    window.setFasting = function(val) {
        ensureDayObj(activeDayNum);
        fullHistory[activeDayNum].fasting = val;
        renderDay(activeDayNum);
        saveData();
        if(val) {
            hapticBurst(15);
            if(window.confetti) {
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#d4af37', '#ffffff', '#27ae60'] });
            }
        } else {
            haptic();
        }
    }
    
    window.openCityModal = function() { document.getElementById('btnCalendar').click(); }

    window.addNewCustom = function(category, inputId) {
        const inp = document.getElementById(inputId);
        const val = inp.value.trim();
        if(!val) return;
        
        // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ü–µ–ª—å –Ω–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –º–µ—Å—è—Ü–∞, –µ—Å–ª–∏ –µ–µ —Ç–∞–º –µ—â–µ –Ω–µ—Ç
        for(let d=1; d<=30; d++) {
            ensureDayObj(d);
            if(!fullHistory[d][category]) fullHistory[d][category] = [];
            const exists = fullHistory[d][category].find(g => g.text === val);
            if(!exists) fullHistory[d][category].push({ text: val, done: false });
        }
        
        inp.value = "";
        renderDay(activeDayNum); saveData(); haptic();
    }

    window.removeCustom = function(category, idx) {
        if(!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ü–µ–ª—å?')) return;
        ensureDayObj(activeDayNum);
        const textToRemove = fullHistory[activeDayNum][category][idx].text;
        
        // –£–¥–∞–ª—è–µ–º —Ü–µ–ª—å –∏–∑ –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è –º–µ—Å—è—Ü–∞, —Å–æ—Ö—Ä–∞–Ω—è—è –æ—Å—Ç–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å
        for(let d=1; d<=30; d++) {
            if(fullHistory[d] && fullHistory[d][category]) {
                fullHistory[d][category] = fullHistory[d][category].filter(g => g.text !== textToRemove);
            }
        }
        renderDay(activeDayNum); saveData();
    }

    window.toggleCustom = function(category, idx) {
        ensureDayObj(activeDayNum);
        const current = fullHistory[activeDayNum][category][idx].done;
        fullHistory[activeDayNum][category][idx].done = !current;
        renderDay(activeDayNum); saveData(); 
        if(!current) hapticBurst(4); else haptic();
    }

    window.hideHardcodedTask = function(taskId, e) {
        e.stopPropagation();
        if(!confirm('–°–∫—Ä—ã—Ç—å —ç—Ç–æ—Ç –ø—É–Ω–∫—Ç –∏–∑ —Ç—Ä–µ–∫–µ—Ä–∞ –Ω–∞–≤—Å–µ–≥–¥–∞?')) return;
        if(!fullHistory.settings) fullHistory.settings = { hiddenTasks: [] };
        if(!fullHistory.settings.hiddenTasks.includes(taskId)) {
            fullHistory.settings.hiddenTasks.push(taskId);
        }
        renderDay(activeDayNum); saveData(); haptic();
    }

    window.toggleZakat = function(isPaid) {
        sysSave('zakat_paid', isPaid ? 'true' : 'false');
        updateZakatUI(isPaid);
        haptic();
    }
    
    function updateZakatUI(isPaid) {
        const btnYes = document.getElementById('zakatYes');
        const btnNo = document.getElementById('zakatNo');
        if(btnYes && btnNo) {
            btnYes.className = 'fasting-option';
            btnNo.className = 'fasting-option';
            if(isPaid) btnYes.classList.add('active-hold'); 
            else btnNo.classList.add('active-nothold');
        }
    }

    // === NOTIFICATIONS LOGIC ===
    window.toggleNotify = function(type) {
        if(!fullHistory.settings) fullHistory.settings = { hiddenTasks: [] };
        if(!fullHistory.settings.notifications) fullHistory.settings.notifications = { fasting: false, namaz: false };
        
        const current = fullHistory.settings.notifications[type];
        
        if(!current) {
            if(tg && tg.showPopup) {
                tg.showPopup({
                    title: '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è',
                    message: type === 'namaz' ? '–í–∫–ª—é—á–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –Ω–∞—Å—Ç—É–ø–ª–µ–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞–º–∞–∑–æ–≤?' : '–í–∫–ª—é—á–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –≤—Ä–µ–º–µ–Ω–∏ –°—É—Ö—É—Ä–∞ –∏ –ò—Ñ—Ç–∞—Ä–∞?',
                    buttons: [{type: 'default', text: '–î–∞', id: 'yes'}, {type: 'destructive', text: '–ù–µ—Ç', id: 'no'}]
                }, function(btnId) {
                    if(btnId === 'yes') {
                        fullHistory.settings.notifications[type] = true;
                        updateBellsUI(); saveData(); sendUserDataToServer(); hapticBurst(2);
                    }
                });
                return;
            } else {
                if(!confirm('–í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è?')) return;
            }
        }
        
        // –û—Ç–∫–ª—é—á–µ–Ω–∏–µ
        fullHistory.settings.notifications[type] = !current;
        updateBellsUI();
        saveData();
        sendUserDataToServer();
        if(!current) hapticBurst(2); else haptic();
    }

    function updateBellsUI() {
        if(!fullHistory.settings || !fullHistory.settings.notifications) return;
        ['fasting', 'namaz'].forEach(type => {
            const bell = document.getElementById('bell-' + type);
            if(bell) {
                const icon = bell.querySelector('i');
                if(fullHistory.settings.notifications[type]) {
                    bell.classList.add('active');
                    icon.className = 'ph-fill ph-bell';
                } else {
                    bell.classList.remove('active');
                    icon.className = 'ph ph-bell';
                }
            }
        });
    }

    function sendUserDataToServer() {
        if(!tg || !tg.initDataUnsafe || !tg.initDataUnsafe.user) return;
        const tg_id = tg.initDataUnsafe.user.id;
        const city = localStorage.getItem(CITY_NAME_KEY) || "";
        const notifs = fullHistory.settings.notifications || { fasting: false, namaz: false };
        
        // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –≤–∞—à URL —Å–µ—Ä–≤–µ—Ä–∞ FastAPI –¥–ª—è –ø—Ä–∏–µ–º–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        fetch('https://–≤–∞—à-—Å–µ—Ä–≤–µ—Ä.com/api/update_user', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                tg_id: tg_id,
                city: city,
                notify_fasting: notifs.fasting,
                notify_namaz: notifs.namaz
            })
        }).catch(e => console.log("–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–æ–Ω–µ"));
    }

    function updateSectionProgress(section) {
        const title = section.querySelector('.section-title').innerText;
        let percent = 0;
        
        if(title.includes("–õ–∏—á–Ω–æ—Å—Ç—å")) {
             ensureDayObj(activeDayNum);
             const data = fullHistory[activeDayNum];
             let total = 2; let checked = 0; 
             if(data && data.tasks) {
                 if(data.tasks.no_bad_words) checked++;
                 if(data.tasks.no_gossip) checked++;
                 if(!fullHistory.settings.hiddenTasks.includes('sadaqah')) {
                     total++;
                     if(data.tasks.sadaqah) checked++;
                 }
             }
             if(data && data.extraGoals) {
                 total += data.extraGoals.length;
                 data.extraGoals.forEach(g => { if(g.done) checked++; });
             }
             if(total === 0) percent = 0; else percent = Math.round((checked / total) * 100);
        } else if(title.includes("–ü–∏—Ç–∞–Ω–∏–µ")) {
             ensureDayObj(activeDayNum);
             const data = fullHistory[activeDayNum];
             let total = 1; let checked = 0;
             if(data && data.water > 0) checked++; 
             
             if(!fullHistory.settings.hiddenTasks.includes('suhoor')) { total++; if(data?.tasks?.suhoor) checked++; }
             if(!fullHistory.settings.hiddenTasks.includes('no_overeat')) { total++; if(data?.tasks?.no_overeat) checked++; }
             
             percent = Math.round((checked / total) * 100);
        } else if(title.includes("–ó–Ω–∞–Ω–∏—è")) {
             ensureDayObj(activeDayNum);
             const data = fullHistory[activeDayNum];
             let total = 1; let checked = 0; 
             if(data && data.quranPageCount > 0) checked++;
             
             if(!fullHistory.settings.hiddenTasks.includes('lecture')) { total++; if(data?.tasks?.lecture) checked++; }
             if(!fullHistory.settings.hiddenTasks.includes('arabic')) { total++; if(data?.tasks?.arabic) checked++; }
             
             if(data && data.extraKnowledge) {
                 total += data.extraKnowledge.length;
                 data.extraKnowledge.forEach(g => { if(g.done) checked++; });
             }
             percent = Math.round((checked / total) * 100);
        } else {
            const totalItems = section.querySelectorAll('.task-item').length;
            if(totalItems === 0) return; 
            const checkedItems = section.querySelectorAll('.task-item.checked').length;
            percent = Math.round((checkedItems / totalItems) * 100);
        }
        
        const fill = section.querySelector('.progress-bar-fill');
        const text = section.querySelector('.section-percent');
        if(fill && text) {
            fill.style.width = percent + "%"; text.innerText = percent + "%";
            fill.style.backgroundColor = (percent === 100) ? "#27ae60" : "#d4af37";
        }
    }

    function updateDailyCircle() {
        const score = calculateDayScore(fullHistory[activeDayNum]);
        const percent = score / 100;
        const offset = 330 - (percent * 330);
        const circle = document.getElementById('monthCircle');
        circle.style.strokeDashoffset = offset;
        if(percent < 0.3) circle.style.stroke = "#e74c3c"; 
        else if(percent < 0.8) circle.style.stroke = "#d4af37"; 
        else circle.style.stroke = "#27ae60"; 
    }

    document.getElementById('prevDay').addEventListener('click', () => { if(activeDayNum>1){activeDayNum--; renderDay(activeDayNum); haptic();} });
    document.getElementById('nextDay').addEventListener('click', () => { if(activeDayNum<realDayNum){activeDayNum++; renderDay(activeDayNum); haptic();} });
    
    window.toggleTask = function(el, id) { 
        if(event.target.tagName === 'INPUT' || event.target.className === 'delete-custom' || event.target.className.includes('counter-')) return;
        if(el.classList.contains('task-text') || el.classList.contains('checkbox')) el = el.parentElement;
        el.classList.toggle('checked'); ensureDayObj(activeDayNum); 
        const isChecked = el.classList.contains('checked');
        fullHistory[activeDayNum].tasks[id] = isChecked; 
        updateSectionProgress(el.closest('.tracker-section')); updateDailyCircle(); saveData(); 
        if(isChecked) { hapticBurst(2); } else haptic(); 
    }
    
    let thoughtsSaveTimeout;
    window.saveThoughts = function() { 
        ensureDayObj(activeDayNum); 
        fullHistory[activeDayNum].thoughts = document.getElementById('dailyThoughts').value; 
        clearTimeout(thoughtsSaveTimeout); thoughtsSaveTimeout = setTimeout(saveData, 500); 
    }

    document.querySelectorAll('.star').forEach(s => s.addEventListener('click', function() { ensureDayObj(activeDayNum); fullHistory[activeDayNum].rating = parseInt(this.dataset.val); renderDay(activeDayNum); saveData(); haptic(); }));

    function ensureDayObj(d){ if(!fullHistory[d]) fullHistory[d] = {tasks:{}, rating:0, thoughts:"", fasting:false, extraGoals:[], extraPrayers:[], extraKnowledge:[], water:0, quranPageCount: 0}; }
    
    function saveData(){
        const val = JSON.stringify(fullHistory);
        const status = document.getElementById('syncStatus');
        status.innerText = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...";
        const key = STORAGE_KEY;
        
        localStorage.setItem(key, val); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ–≥–¥–∞ –ª–æ–∫–∞–ª—å–Ω–æ
        
        const cb = (e) => { 
            if(!e) { 
                status.innerText = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ"; 
                status.classList.add('active'); 
                setTimeout(() => status.classList.remove('active'), 1000); 
            } 
        };
        
        // –û—Ç–¥–∞–µ–º —Å—Ç—Ä–æ–≥–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç Telegram Cloud
        if(tg && tg.CloudStorage) {
            tg.CloudStorage.setItem(key, val, cb);
        } else {
            cb(null);
        }
    }
    
    function haptic(){ if(tg && tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light'); }
    function hapticBurst(count) {
        if (!tg || !tg.HapticFeedback) return;
        if(count > 20) count = 20; 
        let i = 0; let interval = setInterval(() => { tg.HapticFeedback.impactOccurred('light'); i++; if (i >= count) clearInterval(interval); }, 40); 
    }
    
    window.closeModal = function(id){ document.getElementById(id).classList.remove('show'); document.body.classList.remove('no-scroll'); }

    // === API LOGIC ===
    document.getElementById('btnCalendar').addEventListener('click', () => {
        document.body.classList.add('no-scroll');
        renderCalendarUI();
        document.getElementById('modalCalendar').classList.add('show');
    });

    function renderCalendarUI() {
        const container = document.getElementById('calContent');
        const calendar = getStoredCalendar();
        
        if (!calendar) {
            renderSearchUI(container);
        } else {
            renderTableUI(container, calendar);
        }
    }

    function renderSearchUI(container) {
        container.innerHTML = `
            <div class="search-container">
                <input type="text" class="search-input" id="citySearchInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ö–∞–∑–∞–Ω—å)">
                <div class="search-results" id="searchResults"></div>
            </div>
        `;
        const inp = document.getElementById('citySearchInput');
        let debounce;
        inp.addEventListener('input', (e) => {
            clearTimeout(debounce);
            debounce = setTimeout(() => searchCity(e.target.value), 600);
        });
        inp.focus();
    }

    function searchCity(query) {
        if(query.length < 3) return;
        const resDiv = document.getElementById('searchResults');
        resDiv.innerHTML = '<div style="text-align:center;color:#666; margin-top:20px;">–ü–æ–∏—Å–∫...</div>';
        
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&accept-language=ru&featuretype=settlement`)
            .then(r => r.json())
            .then(data => {
                resDiv.innerHTML = '';
                
                data = data.filter(item => {
                    const type = item.addresstype || item.type;
                    const badTypes = ['amenity', 'building', 'highway', 'house', 'shop', 'office', 'tourism', 'leisure', 'historic', 'railway', 'aeroway'];
                    return !badTypes.includes(type);
                });

                if(data.length === 0) { resDiv.innerHTML = '<div style="text-align:center;color:#666;">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</div>'; return; }
                
                const cis = ['–∫–∞–∑–∞—Ö—Å—Ç–∞–Ω', '—Ä–æ—Å—Å–∏—è', '—É–∫—Ä–∞–∏–Ω–∞', '—Ç—É—Ä—Ü–∏—è', '–±–µ–ª–∞—Ä—É—Å—å', '—É–∑–±–µ–∫–∏—Å—Ç–∞–Ω', '–∫—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω', '—Ç–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω', '–∞–∑–µ—Ä–±–∞–π–¥–∂–∞–Ω'];
                data.sort((a, b) => {
                    const aCis = cis.some(c => a.display_name.toLowerCase().includes(c));
                    const bCis = cis.some(c => b.display_name.toLowerCase().includes(c));
                    return (aCis === bCis) ? 0 : aCis ? -1 : 1;
                });

                data.slice(0, 5).forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'search-item';
                    const simpleName = item.display_name.split(',')[0];
                    el.innerText = simpleName; 
                    el.onclick = () => loadCalendarForLocation(item.lat, item.lon, simpleName, item.display_name);
                    resDiv.appendChild(el);
                });
            })
            .catch(() => { resDiv.innerHTML = '<div style="text-align:center;color:#e74c3c;">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏</div>'; });
    }

    function loadCalendarForLocation(lat, lon, cityName, fullName) {
        const resDiv = document.getElementById('searchResults');
        resDiv.innerHTML = '<div style="text-align:center;color:var(--accent); margin-top:20px;">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è...</div>';
        
        const p1 = fetch(`https://api.aladhan.com/v1/calendar?latitude=${lat}&longitude=${lon}&method=3&month=2&year=2026`).then(r=>r.json());
        const p2 = fetch(`https://api.aladhan.com/v1/calendar?latitude=${lat}&longitude=${lon}&method=3&month=3&year=2026`).then(r=>r.json());

        Promise.all([p1, p2]).then(([d1, d2]) => {
            let finalCalendar = [];
            const arr1 = d1.data || [];
            const arr2 = d2.data || [];
            const fullArr = [...arr1, ...arr2];

            const cisKeywords = ['–∫–∞–∑–∞—Ö—Å—Ç–∞–Ω', '—Ä–æ—Å—Å–∏—è', '—É–∫—Ä–∞–∏–Ω–∞', '—Ç—É—Ä—Ü–∏—è', 'kazakhstan', 'russia', 'ukraine', 'turkey'];
            const isCis = cisKeywords.some(kw => fullName.toLowerCase().includes(kw));
            
            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞ –†–∞–º–∞–¥–∞–Ω–∞
            ramadanStart = isCis ? new Date(2026, 1, 19) : new Date(2026, 1, 18);
            sysSave(COUNTRY_FLAG_KEY, isCis ? 'true' : 'false');

            // 18-–µ —Ñ–µ–≤—Ä–∞–ª—è –≤ –º–∞—Å—Å–∏–≤–µ —Ñ–µ–≤—Ä–∞–ª—è - —ç—Ç–æ –∏–Ω–¥–µ–∫—Å 17
            // 19-–µ —Ñ–µ–≤—Ä–∞–ª—è –≤ –º–∞—Å—Å–∏–≤–µ —Ñ–µ–≤—Ä–∞–ª—è - —ç—Ç–æ –∏–Ω–¥–µ–∫—Å 18
            const startIndex = isCis ? 18 : 17; 
            
            for(let i=0; i<30; i++) {
                if(fullArr[startIndex + i]) {
                     const dayObj = fullArr[startIndex + i];
                     finalCalendar.push({
                        date: dayObj.date.readable,
                        fajr: dayObj.timings.Fajr.split(' ')[0],
                        dhuhr: dayObj.timings.Dhuhr.split(' ')[0],
                        asr: dayObj.timings.Asr.split(' ')[0],
                        maghrib: dayObj.timings.Maghrib.split(' ')[0],
                        isha: dayObj.timings.Isha.split(' ')[0]
                    });
                }
            }
            
            sysSave(CALENDAR_STORAGE_KEY, JSON.stringify(finalCalendar));
            sysSave(CITY_NAME_KEY, cityName);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –ø–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ —é–∑–µ—Ä –≤—ã–±—Ä–∞–ª/—Å–º–µ–Ω–∏–ª –≥–æ—Ä–æ–¥
            sendUserDataToServer();
            
            // –ü–µ—Ä–µ—Å—á–µ—Ç —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è –ø–æ—Å–ª–µ —Å–º–µ–Ω—ã —Ä–µ–≥–∏–æ–Ω–∞
            realDayNum = getCurrentDay();
            activeDayNum = realDayNum;
            
            renderTableUI(document.getElementById('calContent'), finalCalendar);
            renderDay(activeDayNum);
        }).catch(e => {
            console.error(e);
            resDiv.innerHTML = '<div style="text-align:center;color:red;">–û—à–∏–±–∫–∞ API</div>';
        });
    }

    function renderTableUI(container, calendar) {
        const cityName = localStorage.getItem(CITY_NAME_KEY) || "–ì–æ—Ä–æ–¥";
        let h = `<div class="current-city-info">üìç ${cityName}</div>`;
        h += `<div style="text-align:center; font-size:11px; color:#aaa; margin-bottom:10px;">* –í—Å–µ –≤—Ä–µ–º—è –Ω–∞–º–∞–∑–æ–≤ —É–∫–∞–∑–∞–Ω–æ –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ</div>`;
        h += `<button class="btn-set-city" onclick="resetCity()" style="margin-bottom:15px; border:1px solid #444;">üîÑ –°–º–µ–Ω–∏—Ç—å –≥–æ—Ä–æ–¥</button>`;
        h += `<div class="prayer-table-container"><table class="prayer-table"><thead><tr><th>–î</th><th>–§–∞–¥–∂—Ä<br><span class="th-sub">(–°—É—Ö—É—Ä)</span></th><th>–ó—É—Ö—Ä</th><th>–ê—Å—Ä</th><th>–ú–∞–≥—Ä–∏–±<br><span class="th-sub">(–ò—Ñ—Ç–∞—Ä)</span></th><th>–ò—à–∞</th></tr></thead><tbody>`;
        
        calendar.forEach((day, idx) => {
            let isT = (idx+1)===activeDayNum ? 'class="today-row"' : '';
            h += `<tr ${isT}>
                <td>${idx+1}</td>
                <td style="font-weight:700;color:#fff">${day.fajr}</td>
                <td>${day.dhuhr}</td>
                <td>${day.asr}</td>
                <td style="font-weight:700;color:var(--accent)">${day.maghrib}</td>
                <td>${day.isha}</td>
            </tr>`;
        });
        h += `</tbody></table></div>`;
        container.innerHTML = h;
    }

    window.resetCity = function() {
        localStorage.removeItem(CALENDAR_STORAGE_KEY);
        if(tg && tg.CloudStorage) tg.CloudStorage.removeItem(CALENDAR_STORAGE_KEY);
        renderCalendarUI();
    }

    // === STATS LOGIC ===
    function calculateDetailedStats() {
        let stats = {
            fasting: 0, fajr: 0, dhuhr: 0, asr: 0, maghrib: 0, isha: 0,
            sunnah: 0, tarawih: 0, witr: 0, tahajjud: 0,
            quran_read: 0, lecture: 0, arabic: 0, sadaqah: 0, suhoor: 0,
            no_bad_words: 0, no_gossip: 0, no_overeat: 0,
            water_liters: 0, quran_pages_total: 0, custom_goals_breakdown: {} 
        };

        for(let i=1; i<=30; i++) {
            const d = fullHistory[i];
            if(!d) continue;
            if(d.fasting === true) stats.fasting++;
            if(d.tasks) { for(let key in stats) { if(d.tasks[key]) stats[key]++; } }
            if(d.water) stats.water_liters += (d.water * 0.25); 
            if(d.quranPageCount) { 
                stats.quran_pages_total += d.quranPageCount; 
                if(d.quranPageCount > 0) stats.quran_read++;
            }
            
            ['extraGoals', 'extraKnowledge', 'extraPrayers'].forEach(cat => {
                if(d[cat] && d[cat].length > 0) {
                    d[cat].forEach(g => {
                        if(g.done) {
                            const t = g.text.trim() || "–°–≤–æ—è —Ü–µ–ª—å";
                            if(!stats.custom_goals_breakdown[t]) stats.custom_goals_breakdown[t] = 0;
                            stats.custom_goals_breakdown[t]++;
                        }
                    });
                }
            });
        }
        return stats;
    }

    function generateDetailedStatsHTML(stats) {
        const labels = {
            fasting: "–î–Ω–µ–π –ø–æ—Å—Ç–∞", fajr: "–§–∞–¥–∂—Ä", dhuhr: "–ó—É—Ö—Ä", asr: "–ê—Å—Ä", maghrib: "–ú–∞–≥—Ä–∏–±", isha: "–ò—à–∞",
            sunnah: "–°—É–Ω–Ω–∞ –Ω–∞–º–∞–∑—ã", tarawih: "–¢–∞—Ä–∞–≤–∏—Ö", witr: "–í–∏—Ç—Ä", tahajjud: "–¢–∞—Ö–∞–¥–∂—É–¥",
            quran_read: "–î–Ω–µ–π —á—Ç–µ–Ω–∏—è –ö—ä—É—Ä'–∞–Ω–∞", lecture: "–õ–µ–∫—Ü–∏–∏", arabic: "–ê—Ä–∞–±—Å–∫–∏–π",
            sadaqah: "–°–¥–µ–ª–∞–ª –°–∞–¥–∞–∫–∞", no_bad_words: "–ù–µ –∑–ª–æ—Å–ª–æ–≤–∏–ª", no_gossip: "–ù–µ —Å–ø–ª–µ—Ç–Ω–∏—á–∞–ª", no_overeat: "–ù–µ –ø–µ—Ä–µ–µ–¥–∞–ª –Ω–∞ –∏—Ñ—Ç–∞—Ä", suhoor: "–í—Å—Ç–∞–≤–∞–ª –Ω–∞ —Å—É—Ö—É—Ä"
        };
        let html = '';
        html += `<div class="full-stat-item"><span class="fs-name">${labels.fasting}</span><span class="fs-val">${stats.fasting}/30</span></div>`;
        ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'].forEach(p => { html += `<div class="full-stat-item"><span class="fs-name">${labels[p]}</span><span class="fs-val">${stats[p]}/30</span></div>`; });
        ['sunnah', 'tarawih', 'witr', 'tahajjud'].forEach(p => { if(stats[p] > 0) html += `<div class="full-stat-item"><span class="fs-name">${labels[p]}</span><span class="fs-val">${stats[p]} —Ä–∞–∑</span></div>`; });
        html += `<div class="group-label" style="margin-top:10px;">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>`;
        if(stats.quran_pages_total > 0) html += `<div class="full-stat-item"><span class="fs-name">–ü—Ä–æ—á–∏—Ç–∞–Ω–æ —Å—Ç—Ä–∞–Ω–∏—Ü –ö—ä—É—Ä–∞–Ω–∞</span><span class="fs-val">${stats.quran_pages_total} —Å—Ç—Ä.</span></div>`;
        else if(stats.quran_read > 0) html += `<div class="full-stat-item"><span class="fs-name">${labels.quran_read}</span><span class="fs-val">${stats.quran_read} –¥–Ω.</span></div>`;
        if(stats.water_liters > 0) html += `<div class="full-stat-item"><span class="fs-name">–í—ã–ø–∏—Ç–æ –≤–æ–¥—ã</span><span class="fs-val">${stats.water_liters} –ª.</span></div>`;
        ['suhoor', 'no_overeat', 'sadaqah', 'lecture', 'arabic', 'no_bad_words', 'no_gossip'].forEach(p => { if(stats[p] > 0) html += `<div class="full-stat-item"><span class="fs-name">${labels[p]}</span><span class="fs-val">${stats[p]} –¥–Ω.</span></div>`; });
        if(Object.keys(stats.custom_goals_breakdown).length > 0) {
            html += `<div class="group-label" style="margin-top:10px;">–ú–æ–∏ —Ü–µ–ª–∏</div>`;
            for(let [name, count] of Object.entries(stats.custom_goals_breakdown)) { html += `<div class="full-stat-item"><span class="fs-name">${name}</span><span class="fs-val">${count} —Ä–∞–∑</span></div>`; }
        }
        return html;
    }

    document.getElementById('btnStats').addEventListener('click', () => {
        document.body.classList.add('no-scroll');
        
        let totalScoreSum = 0;
        let daysWithScore = 0;
        let filledDaysCount = 0;

        const grid = document.getElementById('heatmapGrid'); grid.innerHTML = ''; 
        
        for(let i=1; i<=30; i++) {
            const dayData = fullHistory[i];
            const score = dayData ? calculateDayScore(dayData) : 0;
            const cell = document.createElement('div'); cell.className = 'heatmap-day';
            
            if(dayData && score > 0) {
                cell.innerText = score; 
                if(score >= 80) cell.classList.add('good'); else if(score >= 40) cell.classList.add('medium'); else if(score > 0) cell.classList.add('bad');
                
                filledDaysCount++;
                totalScoreSum += score;
                daysWithScore++;
            } else { 
                cell.innerText = i; 
                cell.style.opacity = "0.3"; 
            }
            grid.appendChild(cell);
        }

        const now = new Date();
        const startZero = new Date(ramadanStart.getFullYear(), ramadanStart.getMonth(), ramadanStart.getDate());
        const nowZero = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        let daysPassedReal = Math.ceil((nowZero - startZero) / (1000 * 60 * 60 * 24)) + 1;
        if(daysPassedReal < 0) daysPassedReal = 0;
        if(daysPassedReal > 30) daysPassedReal = 30;

        document.getElementById('statDays').innerText = daysPassedReal; 
        
        let avgRatingVal = 0;
        if(daysWithScore > 0) {
            const avgPercent = totalScoreSum / daysWithScore;
            avgRatingVal = (avgPercent / 20); 
        }
        document.getElementById('statRating').innerText = avgRatingVal.toFixed(1);

        const avgScore = filledDaysCount > 0 ? (totalScoreSum / filledDaysCount) : 0;
        let msg = "";
        if(filledDaysCount === 0) msg = "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—É—Å—Ç–∞. –ù–∞—á–Ω–∏ –æ—Ç–º–µ—á–∞—Ç—å –¥–Ω–∏!";
        else if(avgScore >= 90) msg = "–ú–∞—à–∞–ê–ª–ª–∞—Ö! –¢—ã –∏–¥–µ—à—å –æ—á–µ–Ω—å –º–æ—â–Ω–æ. –¢–∞–∫ –¥–µ—Ä–∂–∞—Ç—å!";
        else if(avgScore >= 80) msg = "–û—Ç–ª–∏—á–Ω—ã–π —Ç–µ–º–ø. –ù–µ —Å–±–∞–≤–ª—è–π –æ–±–æ—Ä–æ—Ç—ã!";
        else if(avgScore >= 60) msg = "–ù–µ–ø–ª–æ—Ö–æ, –Ω–æ –µ—Å—Ç—å –ø—Ä–æ—Å–∞–¥–∫–∏. –ü–æ—Å—Ç–∞—Ä–∞–π—Å—è —á—É—Ç—å —É—Å–µ—Ä–¥–Ω–µ–µ.";
        else if(avgScore >= 40) msg = "–ë—Ä–∞—Ç/–°–µ—Å—Ç—Ä–∞, –Ω—É–∂–Ω–æ –ø–æ–¥–Ω–∞–∂–∞—Ç—å. –†–∞–º–∞–¥–∞–Ω —É—Ö–æ–¥–∏—Ç.";
        else msg = "–û—á–µ–Ω—å —Å–ª–∞–±—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –ü—Ä–æ—Å–Ω–∏—Å—å! –≠—Ç–æ –º–µ—Å—è—Ü –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π.";
        
        document.getElementById('aiText').innerText = msg;
        const detailedStats = calculateDetailedStats();
        document.getElementById('statFullList').innerHTML = generateDetailedStatsHTML(detailedStats);
        document.getElementById('modalStats').classList.add('show');
    });

    document.getElementById('btnFinish').addEventListener('click', function() { 
        saveData(); 
        const btn = this; const originalText = btn.innerText; btn.innerText = "–°–û–•–†–ê–ù–ï–ù–û!"; 
        if(tg && tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
        setTimeout(() => { btn.innerText = originalText; }, 2000);
        if (activeDayNum === 30) setTimeout(showFinalReport, 1000);
    });

    function showFinalReport() {
        let totalScore = 0, missedFast = 0, thoughts = [];
        for(let i=1; i<=30; i++) {
            const d = fullHistory[i];
            if(!d) { missedFast++; continue; }
            totalScore += calculateDayScore(d);
            if(d.fasting === false) missedFast++;
            if(d.thoughts && d.thoughts.length > 5) thoughts.push(d.thoughts);
        }
        const avgScore = Math.round(totalScore / 30);
        document.getElementById('f_avg').innerText = avgScore + "%";
        document.getElementById('f_fast').innerText = missedFast;
        const thoughtsContainer = document.getElementById('f_thoughts');
        if(thoughts.length > 0) thoughtsContainer.innerHTML = thoughts.slice(0, 5).map(t => `<div class="thought-entry">"${t}"</div>`).join('');
        else thoughtsContainer.innerText = "–¢—ã –Ω–µ –∑–∞–ø–∏—Å—ã–≤–∞–ª –º—ã—Å–ª–∏.";
        const detailedStats = calculateDetailedStats();
        document.getElementById('f_fullList').innerHTML = generateDetailedStatsHTML(detailedStats);
        let msg = "";
        if(avgScore > 80) msg = "–ú–∞—à–∞–ê–ª–ª–∞—Ö! –≠—Ç–æ –±—ã–ª –º–æ—â–Ω—ã–π –†–∞–º–∞–¥–∞–Ω. –¢—ã –ø–æ–∫–∞–∑–∞–ª –æ—Ç–ª–∏—á–Ω—É—é –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—É. –ü—É—Å—Ç—å –≤—Å—ë –±—É–¥–µ—Ç –ø—Ä–∏–Ω—è—Ç–æ!";
        else if(avgScore > 50) msg = "–•–æ—Ä–æ—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –ë—ã–ª–∏ –ø—Ä–æ–ø—É—Å–∫–∏, –Ω–æ —Ç—ã —Å—Ç–∞—Ä–∞–ª—Å—è. –í —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑ –∏–Ω —à–∞ –ê–ª–ª–∞—Ö –±—É–¥–µ—Ç –µ—â–µ –ª—É—á—à–µ!";
        else msg = "–ú–µ—Å—è—Ü –ø—Ä–æ—à–µ–ª —Ç—è–∂–µ–ª–æ. –ì–ª–∞–≤–Ω–æ–µ ‚Äî –Ω–µ –æ—Ç—á–∞–∏–≤–∞—Ç—å—Å—è. –ù–∞—á–Ω–∏ –≥–æ—Ç–æ–≤–∏—Ç—å—Å—è –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –†–∞–º–∞–¥–∞–Ω—É —É–∂–µ —Å–µ–π—á–∞—Å.";
        document.getElementById('f_robot').innerText = msg;
        document.getElementById('modalFinal').classList.add('show');
    }

    document.getElementById('btnShare').addEventListener('click', () => {
        document.body.classList.add('no-scroll');
        const d = fullHistory[activeDayNum] || {}; 
        const score = calculateDayScore(d);
        const rating = d.rating || 0;
        
        const date = new Date(ramadanStart); 
        date.setDate(ramadanStart.getDate() + (activeDayNum - 1));
        document.getElementById('renderDate').innerText = date.toLocaleDateString('ru-RU', {day:'numeric', month:'long'});
        document.getElementById('renderDayNum').innerText = activeDayNum;
        
        let aiMsg = "–î–µ–Ω—å –ø—Ä–æ—à–µ–ª. –ü–æ—Å—Ç–æ—è–Ω—Å—Ç–≤–æ ‚Äî –∫–ª—é—á –∫ —É—Å–ø–µ—Ö—É.";
        if(score >= 80) aiMsg = "üî• –ú–∞—à–∞–ê–ª–ª–∞—Ö! –û—á–µ–Ω—å –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ã–π –¥–µ–Ω—å. –ü—É—Å—Ç—å –≤—Å—ë –±—É–¥–µ—Ç –ø—Ä–∏–Ω—è—Ç–æ!"; 
        else if(score >= 50) aiMsg = "üí™ –•–æ—Ä–æ—à–∞—è —Ä–∞–±–æ—Ç–∞, –Ω–æ –º–æ–∂–Ω–æ –ª—É—á—à–µ. –°—Ç–∞—Ä–∞–π—Å—è —É—Å–µ—Ä–¥–Ω–µ–µ."; 
        else aiMsg = "–ù–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π—Å—è. –ö–∞–∂–¥—ã–π –¥–µ–Ω—å ‚Äî —ç—Ç–æ –Ω–æ–≤—ã–π —à–∞–Ω—Å —Å—Ç–∞—Ç—å –ª—É—á—à–µ.";
        document.getElementById('renderAiText').innerText = aiMsg;

        let starsHtml = ''; 
        for(let i=1; i<=5; i++) { 
            starsHtml += `<span style="color:${i<=rating ? '#d4af37' : '#333'}">‚òÖ</span>`; 
        }
        document.getElementById('renderStars').innerHTML = starsHtml;

        const canvas = document.getElementById('renderCanvas');
        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;
        const centerX = width / 2;
        const centerY = height / 2;
        const radius = 125; 
        ctx.clearRect(0, 0, width, height);
        ctx.lineWidth = 15; 
        ctx.lineCap = 'round';
        const startAngle = (135 * Math.PI) / 180;
        const endAngle = (405 * Math.PI) / 180;
        ctx.strokeStyle = 'rgba(255,255,255,0.05)';
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, startAngle, endAngle); 
        ctx.stroke();
        const totalAngle = endAngle - startAngle;
        const progressEndAngle = startAngle + (totalAngle * (score / 100));
        if (score > 0) {
            let color = '#27ae60';
            if(score < 30) color = '#e74c3c';
            else if(score < 80) color = '#d4af37';
            ctx.strokeStyle = color;
            ctx.shadowColor = color;
            ctx.shadowBlur = 15;
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, startAngle, progressEndAngle);
            ctx.stroke();
            ctx.shadowBlur = 0; 
        }
        document.getElementById('generatedImageContainer').style.display = 'none';
        document.getElementById('btnGenImage').style.display = 'none';
        document.getElementById('shareHint').style.display = 'none';
        const loader = document.getElementById('loadingState');
        loader.style.display = 'block';
        document.getElementById('modalShare').classList.add('show');
        setTimeout(() => {
            const hiddenWrapper = document.getElementById('hidden-share-container');
            html2canvas(hiddenWrapper, { scale: 2, useCORS: true, backgroundColor: null, allowTaint: true }).then(canvas => {
                loader.style.display = 'none';
                const imgData = canvas.toDataURL("image/png"); 
                const img = document.createElement('img'); 
                img.src = imgData; 
                const imgCont = document.getElementById('generatedImageContainer');
                imgCont.innerHTML = ''; 
                imgCont.appendChild(img); 
                imgCont.style.display = 'block';
                const btn = document.getElementById('btnGenImage');
                btn.style.display = 'block';
                btn.innerText = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å";
                document.getElementById('shareHint').style.display = 'block';
                canvas.toBlob(function(blob) {
                    const file = new File([blob], "ramadan_report.png", { type: "image/png" });
                    const shareData = { files: [file], text: "–°–µ–≥–æ–¥–Ω—è –º–æ–π –¥–µ–Ω—å –ø—Ä–æ—à–µ–ª —Ç–∞–∫. –û—Ç—Å–ª–µ–∂–∏–≤–∞—é —ç—Ç–æ –≤ @ramadantracking_bot" };
                    if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                        navigator.share(shareData).catch((err) => { console.log("Auto-share dismissed"); });
                    }
                });
            }).catch(err => { 
                console.error(err);
                loader.innerText = "–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç–∏–Ω–∫–∏";
            });
        }, 500);
    });

    window.manualShare = function() {
        const img = document.querySelector('#generatedImageContainer img');
        if(img) {
            fetch(img.src).then(res => res.blob()).then(blob => {
                const file = new File([blob], "ramadan_report.png", { type: "image/png" });
                const shareData = { files: [file], text: "–°–µ–≥–æ–¥–Ω—è –º–æ–π –¥–µ–Ω—å –ø—Ä–æ—à–µ–ª —Ç–∞–∫. –û—Ç—Å–ª–µ–∂–∏–≤–∞—é —ç—Ç–æ –≤ @ramadantracking_bot" };
                if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                    navigator.share(shareData);
                } else {
                    alert("–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ñ–æ—Ç–æ –¥–æ–ª–≥–∏–º –Ω–∞–∂–∞—Ç–∏–µ–º.");
                }
            });
        }
    }

    initApp();
</script>
</body>
</html>
